name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: integration-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-prek:
    name: prek - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            venv_bin: .venv/bin
          - os: macos-latest
            venv_bin: .venv/bin
          - os: windows-latest
            venv_bin: .venv/Scripts
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify uv is NOT installed
        run: python -c "import shutil, sys; sys.exit(0 if shutil.which('uv') is None else 1)"

      - name: Setup test project
        env:
          MSYS_NO_PATHCONV: 1
        # SETUP_TEST_PROJECT
        # 1. Creates test directory at $RUNNER_TEMP/test-project
        # 2. Creates a virtual environment at .venv
        # 3. Installs runners (prek, pre-commit) into the venv
        # 4. Initializes git repo and creates .pre-commit-config.yaml
        run: python "${{ github.workspace }}/test/setup_test_project.py" --runner both

      - name: First run - installs uv and fails
        id: first_run
        continue-on-error: true
        working-directory: ${{ runner.temp }}/test-project
        run: ${{ matrix.venv_bin }}/prek run --all-files

      - name: Verify first run failed (expected)
        shell: bash
        run: |
          if [ "${{ steps.first_run.outcome }}" = "success" ]; then
            echo "ERROR: First run should have failed but succeeded"
            exit 1
          fi
          echo "First run failed as expected (uv was installed)"

      - name: Verify uv was installed
        shell: bash
        run: |
          if [ -f "$HOME/.local/bin/uv" ] || [ -f "$HOME/.local/bin/uv.exe" ]; then
            echo "uv binary found at ~/.local/bin"
            ls -la "$HOME/.local/bin/"
          else
            echo "ERROR: uv was not installed"
            exit 1
          fi

      - name: Clear prek cache and run again with uv in PATH
        working-directory: ${{ runner.temp }}/test-project
        shell: bash
        run: |
          # Clear hook cache so it picks up new PATH
          rm -rf ~/.cache/prek/hooks/
          export PATH="$HOME/.local/bin:$PATH"
          echo "PATH=$PATH"
          which uv || echo "uv not in which"
          ${{ matrix.venv_bin }}/prek run --all-files

  test-pre-commit:
    name: pre-commit - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            venv_bin: .venv/bin
          - os: macos-latest
            venv_bin: .venv/bin
          - os: windows-latest
            venv_bin: .venv/Scripts
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify uv is NOT installed
        run: python -c "import shutil, sys; sys.exit(0 if shutil.which('uv') is None else 1)"

      - name: Setup test project
        env:
          MSYS_NO_PATHCONV: 1
        # SETUP_TEST_PROJECT
        # 1. Creates test directory at $RUNNER_TEMP/test-project
        # 2. Creates a virtual environment at .venv
        # 3. Installs runners (prek, pre-commit) into the venv
        # 4. Initializes git repo and creates .pre-commit-config.yaml
        run: python "${{ github.workspace }}/test/setup_test_project.py" --runner both

      - name: First run - installs uv and fails
        id: first_run
        continue-on-error: true
        working-directory: ${{ runner.temp }}/test-project
        run: ${{ matrix.venv_bin }}/pre-commit run --all-files

      - name: Verify first run failed (expected)
        shell: bash
        run: |
          if [ "${{ steps.first_run.outcome }}" = "success" ]; then
            echo "ERROR: First run should have failed but succeeded"
            exit 1
          fi
          echo "First run failed as expected (uv was installed)"

      - name: Verify uv was installed
        shell: bash
        run: |
          if [ -f "$HOME/.local/bin/uv" ] || [ -f "$HOME/.local/bin/uv.exe" ]; then
            echo "uv binary found at ~/.local/bin"
            ls -la "$HOME/.local/bin/"
          else
            echo "ERROR: uv was not installed"
            exit 1
          fi

      - name: Clear pre-commit cache and run again with uv in PATH
        working-directory: ${{ runner.temp }}/test-project
        shell: bash
        run: |
          # Clear hook cache so it picks up new PATH
          rm -rf ~/.cache/pre-commit/
          export PATH="$HOME/.local/bin:$PATH"
          echo "PATH=$PATH"
          which uv || echo "uv not in which"
          ${{ matrix.venv_bin }}/pre-commit run --all-files
