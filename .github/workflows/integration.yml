name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: integration-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-prek:
    name: prek - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify uv is NOT installed
        shell: bash
        run: python -c "import shutil, sys; sys.exit(0 if shutil.which('uv') is None else 1)"

      - name: Setup test project
        shell: bash
        # MSYS_NO_PATHCONV=1 prevents Git Bash from corrupting paths on Windows
        # when mixing backslash paths (from $GITHUB_WORKSPACE) with forward slashes
        run: MSYS_NO_PATHCONV=1 python "$GITHUB_WORKSPACE/test/setup_test_project.py" --runner both

      - name: Run hooks with prek
        shell: bash
        working-directory: ${{ runner.temp }}/test-project
        run: |
          # Activate venv and run with prek
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            source .venv/Scripts/activate
          else
            source .venv/bin/activate
          fi
          prek run --all-files

  test-pre-commit:
    name: pre-commit - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify uv is NOT installed
        shell: bash
        run: python -c "import shutil, sys; sys.exit(0 if shutil.which('uv') is None else 1)"

      - name: Setup test project
        shell: bash
        # MSYS_NO_PATHCONV=1 prevents Git Bash from corrupting paths on Windows
        # when mixing backslash paths (from $GITHUB_WORKSPACE) with forward slashes
        run: MSYS_NO_PATHCONV=1 python "$GITHUB_WORKSPACE/test/setup_test_project.py" --runner both

      - name: Run hooks with pre-commit
        shell: bash
        working-directory: ${{ runner.temp }}/test-project
        run: |
          # Activate venv and run with pre-commit
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            source .venv/Scripts/activate
          else
            source .venv/bin/activate
          fi
          pre-commit run --all-files
