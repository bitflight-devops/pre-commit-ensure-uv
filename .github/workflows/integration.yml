name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: integration-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-prek:
    name: prek - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            venv_bin: .venv/bin
          - os: macos-latest
            venv_bin: .venv/bin
          - os: windows-latest
            venv_bin: .venv/Scripts
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify uv is NOT installed
        run: python -c "import shutil, sys; sys.exit(0 if shutil.which('uv') is None else 1)"

      - name: Setup test project
        env:
          MSYS_NO_PATHCONV: 1
        # MSYS_NO_PATHCONV=1 prevents Git Bash from corrupting paths on Windows
        # when mixing backslash paths (from $GITHUB_WORKSPACE) with forward slashes
        # SETUP_TEST_PROJECT
        # 1. Creates test directory at $RUNNER_TEMP/test-project (or ~/tmp/test-project)
        # 2. Creates a virtual environment at .venv using Python's venv module
        # 3. Installs runners (prek, pre-commit, or both) into the venv via pip
        # 4. Verifies the runner executables exist in the venv
        # 5. Initializes git repo with git init and sets user config
        # 6. Creates .pre-commit-config.yaml pointing to the hook being tested
        # 7. Creates a dummy test.txt file
        # 8. Stages files with git add .
        run: python "${{ github.workspace }}/test/setup_test_project.py" --runner both

      - name: Run hooks with prek
        working-directory: ${{ runner.temp }}/test-project
        run: ${{ matrix.venv_bin }}/prek run --all-files

  test-pre-commit:
    name: pre-commit - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            venv_bin: .venv/bin
          - os: macos-latest
            venv_bin: .venv/bin
          - os: windows-latest
            venv_bin: .venv/Scripts
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify uv is NOT installed
        run: python -c "import shutil, sys; sys.exit(0 if shutil.which('uv') is None else 1)"

      - name: Setup test project
        env:
          MSYS_NO_PATHCONV: 1
        # MSYS_NO_PATHCONV=1 prevents Git Bash from corrupting paths on Windows
        # when mixing backslash paths (from $GITHUB_WORKSPACE) with forward slashes
        # SETUP_TEST_PROJECT
        # 1. Creates test directory at $RUNNER_TEMP/test-project (or ~/tmp/test-project)
        # 2. Creates a virtual environment at .venv using Python's venv module
        # 3. Installs runners (prek, pre-commit, or both) into the venv via pip
        # 4. Verifies the runner executables exist in the venv
        # 5. Initializes git repo with git init and sets user config
        # 6. Creates .pre-commit-config.yaml pointing to the hook being tested
        # 7. Creates a dummy test.txt file
        # 8. Stages files with git add .
        run: python "${{ github.workspace }}/test/setup_test_project.py" --runner both

      - name: Run hooks with pre-commit
        working-directory: ${{ runner.temp }}/test-project
        run: ${{ matrix.venv_bin }}/pre-commit run --all-files
