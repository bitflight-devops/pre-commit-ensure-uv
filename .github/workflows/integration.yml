name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: integration-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-prek:
    name: prek - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            venv_bin: .venv/bin
            uv_bin: ~/.local/bin
          - os: macos-latest
            venv_bin: .venv/bin
            uv_bin: ~/.local/bin
          - os: windows-latest
            venv_bin: .venv/Scripts
            uv_bin: ~/.local/bin
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify uv is NOT installed
        run: python -c "import shutil, sys; sys.exit(0 if shutil.which('uv') is None else 1)"

      - name: Setup test project
        env:
          MSYS_NO_PATHCONV: 1
        # SETUP_TEST_PROJECT
        # 1. Creates test directory at $RUNNER_TEMP/test-project
        # 2. Creates a virtual environment at .venv
        # 3. Installs runners (prek, pre-commit) into the venv
        # 4. Initializes git repo and creates .pre-commit-config.yaml
        run: python "${{ github.workspace }}/test/setup_test_project.py" --runner both

      - name: First run - installs uv and fails
        id: first_run
        continue-on-error: true
        working-directory: ${{ runner.temp }}/test-project
        run: ${{ matrix.venv_bin }}/prek run --all-files

      - name: Verify first run failed (expected)
        run: |
          if [ "${{ steps.first_run.outcome }}" = "success" ]; then
            echo "ERROR: First run should have failed but succeeded"
            exit 1
          fi
          echo "First run failed as expected (uv was installed)"
        shell: bash

      - name: Second run - with uv in PATH
        working-directory: ${{ runner.temp }}/test-project
        run: ${{ matrix.venv_bin }}/prek run --all-files
        env:
          PATH: ${{ matrix.uv_bin }}:${{ env.PATH }}

  test-pre-commit:
    name: pre-commit - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            venv_bin: .venv/bin
            uv_bin: ~/.local/bin
          - os: macos-latest
            venv_bin: .venv/bin
            uv_bin: ~/.local/bin
          - os: windows-latest
            venv_bin: .venv/Scripts
            uv_bin: ~/.local/bin
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify uv is NOT installed
        run: python -c "import shutil, sys; sys.exit(0 if shutil.which('uv') is None else 1)"

      - name: Setup test project
        env:
          MSYS_NO_PATHCONV: 1
        # SETUP_TEST_PROJECT
        # 1. Creates test directory at $RUNNER_TEMP/test-project
        # 2. Creates a virtual environment at .venv
        # 3. Installs runners (prek, pre-commit) into the venv
        # 4. Initializes git repo and creates .pre-commit-config.yaml
        run: python "${{ github.workspace }}/test/setup_test_project.py" --runner both

      - name: First run - installs uv and fails
        id: first_run
        continue-on-error: true
        working-directory: ${{ runner.temp }}/test-project
        run: ${{ matrix.venv_bin }}/pre-commit run --all-files

      - name: Verify first run failed (expected)
        run: |
          if [ "${{ steps.first_run.outcome }}" = "success" ]; then
            echo "ERROR: First run should have failed but succeeded"
            exit 1
          fi
          echo "First run failed as expected (uv was installed)"
        shell: bash

      - name: Second run - with uv in PATH
        working-directory: ${{ runner.temp }}/test-project
        run: ${{ matrix.venv_bin }}/pre-commit run --all-files
        env:
          PATH: ${{ matrix.uv_bin }}:${{ env.PATH }}
